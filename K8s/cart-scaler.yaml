kind: ServiceAccount
apiVersion: v1
metadata:
  name: cart-scaler-service-account
  namespace: robot-shop
---
apiVersion: v1
kind: Pod
metadata:
  name: cart-scaler
  namespace: robot-shop
spec:
  serviceAccount: cart-scaler-service-account
  containers:
    - name: kube-cart-scaler
      image: lachlanevenson/k8s-kubectl
      command:
        - /bin/sh
        - -ec
        - |

          i=0
          scaleup="1"
          while true; do
            if [[ $(( $i % 300 )) -eq "0" ]]; then
              if [[ $scaleup -eq "1" ]]; then
                r=$(( $RANDOM % 10 + 5 ))
                kubectl scale deployment cart --replicas $r
                echo "Scaled up to $r"
                scaleup="0"
              else
                kubectl scale deployment cart --replicas 2
                echo "Scaled down to $r"
                scaleup="1"
              fi
            fi

            sleep 1
            i=$((i+1))
            echo "Incremented counter to $i"
          done
      resources:
        limits:
          cpu: 200m
          memory: 100Mi
        requests:
          cpu: 100m
          memory: 50Mi      
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: robot-shop
  name: deployments-updater
rules:
- apiGroups: ["extensions", "apps"]
  resources: ["deployments", "deployments/scale"]
  verbs: ["get", "watch", "update", "patch", "create", "delete", "list"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "watch", "create", "patch", "update", "delete", "list"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: update-deployments
  namespace: robot-shop
subjects:
- kind: ServiceAccount
  name: cart-scaler-service-account
roleRef:
  kind: Role
  name: deployments-updater
  apiGroup: rbac.authorization.k8s.io